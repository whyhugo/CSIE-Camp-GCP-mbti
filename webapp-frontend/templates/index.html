<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Step 2: 串接 NLP API</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style> .spinner-border { display: none; } </style>
</head>
<body>
    <div class="container my-5">
        <h1 class="text-center">第二步：串接 Natural Language API</h1>
        <div class="card p-4 shadow-sm">
            <div class="mb-3">
                <label for="chat-input" class="form-label fw-bold">1. 貼上對話紀錄</label>
                <textarea class="form-control" id="chat-input" rows="10"></textarea>
            </div>
            <div class="mb-3">
                <label for="nickname-input" class="form-label fw-bold">2. 輸入你的暱稱</label>
                <input type="text" class="form-control" id="nickname-input">
            </div>
            <button id="analyze-btn" class="btn btn-primary btn-lg">
                <span class="spinner-border spinner-border-sm"></span>
                分析關鍵詞
            </button>
        </div>
        <div id="results-area" class="alert alert-success mt-4" style="display: none;">
            <h5>分析出的關鍵詞：</h5>
            <p id="keywords-p"></p>
        </div>
    </div>
    <script>
        const analyzeBtn = document.getElementById('analyze-btn');
        const spinner = analyzeBtn.querySelector('.spinner-border');

        analyzeBtn.addEventListener('click', async () => {
            const text = document.getElementById('chat-input').value;
            const nickname = document.getElementById('nickname-input').value;
            if (!text.trim() || !nickname.trim()) {
                alert('請輸入對話紀錄和您的暱稱！');
                return;
            }

            spinner.style.display = 'inline-block';
            analyzeBtn.disabled = true;
            
            const resultsArea = document.getElementById('results-area');
            const keywordsP = document.getElementById('keywords-p');
            resultsArea.style.display = 'none';

            try {
                const response = await fetch('/analyze', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: text, user_name: nickname }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `伺服器錯誤: ${response.status}`);
                }
                
                const data = await response.json();
                keywordsP.textContent = data.keywords.join(', ');
                resultsArea.style.display = 'block';

            } catch (error) {
                alert(`分析失敗：${error.message}`);
            } finally {
                spinner.style.display = 'none';
                analyzeBtn.disabled = false;
            }
        });
    </script>
</body>
</html>